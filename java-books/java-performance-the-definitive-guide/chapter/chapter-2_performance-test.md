# 性能测试方法
> 数据驱动性能调优

## 原则1：测试真是应用
## 原则2：理解批处理流逝时间、吞吐量和响应时间
```md
多角度审视应用性能，具体测量哪些指标取决于对应用最重要的因素。
```
### 批处理流逝时间
> 完成任务花费了多少时间

* 代码优化的热身期
```md
Java 中，由于使用JIT，JVM 会花几分钟全面优化代码并以最高性能执行。
所以 Java的性能优化需要密切关注代码优化的热身期：
大多数时候，应该让运行代码执行足够长时间，已经编译并优化之后再测量性能。
```
* 其他影响应用热身的因素
```md
JPA 通常会从数据库读取数据，从缓存中读取数据，就会更快。
读取文件式，OS 会将文件载入内存，再次读取相同的文件就会更快。
一般来说，应用热身过程中有许多地方会缓存数据，虽然并不那么明显。
```
* 热身期的性能
```md
许多情况下应用从开始到结束的整体性能会更重要，如处理1w 个数据需要花费大量的时间，
但对于最终用户而言，处理前 5k个是否比后5k个慢50%并不重要。

即便是像应用服务器这样的系统，其性能也必然会随着运行时间而改善，但初始的性能仍然很重要。
```
### 吞吐量测试
> 基于一段时间内完成的工作量。
```md
吞吐量测试总是在合适的热身之后进行，特别是因为所测试的东西并不固定。
```
* 场景
```md
* CS 测试
在CS的吞吐测试中，不用考虑客户端的思考时间。

* 单个独立运行的应用
```
* 指标
```md
* TPS （每秒事务数）
* RPS （每秒请求数）
* OPS （每秒操作数）
* QPS （Query Per Second）
```
* 测试风险
```md
客户端可能不能足够快的发送请求，测试不出真实的服务器吞吐能力。
```
* 平均响应时间
```md
吞吐量测试可以报告平均响应时间，但它的变化并不表示性能有问题，除非报告的吞吐量相同。
能够承受 500 OPS，响应时间0.5s的服务器性能要好过 响应时间 0.3s，但只有 400 OPS的服务器。
```
### 响应时间测试
> 从客户端发送请求到收到响应之间的流逝时间。
* 与吞吐量测试差别
```md
响应时间测试的客户端会在操作之间休眠一段时间，这被称为“思考时间”。
响应时间测试是尽量模拟用户的行为。

当测试中引入思考时间，吞吐量就确定了：
指定数量的客户端，在给定思考时间下总是得到相同的TPS（少许差别）。

基于这点，测试响应时间就变得重要了：
服务器的效率取决于它响应固定负载有多快。
```

* 思考时间和吞吐量
```md
两种范式测试客户端包括思考时间的吞吐量：
1. 请求之间休眠一段时间
  这种情况下吞吐量一定程度上依赖响应时间。
2. 周期时间（Cycle Time）
  周期时间设置两次请求之间的总时间，所以客户端的休眠时间依赖于响应时间。
  这种情况下会产生固定的吞吐量。

测试工具中的思考时间时常变化，平均值为特定值，但会加入随机变化以更好的模拟用户行为。
另外，线程调度从来不会严格实时，所以客户端请求之间的时间也会略有差别。

因此，即便工具提供 周期时间而不是思考时间，测试所报告的吞吐量也相差无几。
但是，如果吞吐量远超预期，说明测试中一定出错了。
```
* 平均响应时间 和 百分位请求
```md
区别在于，平局值会受离群值的影响。

* 离群值
Java 由于GC的影响，会更容易受到离群值的影响，
尤其对于有较小的平均响应时间的测试，GC停顿会引入较大的离群值。

通常对于有个别离群值的案例，应该要尽量减少离群值带来的影响（从而降低平均响应时间）。

* 总结 
性能测试中通常关注的是 第90百分位 响应时间（95 或 99 也常有）。
如果只能顶住一个数值，那最好选择基于百分位的响应时间，因为它的减少会让大部分用户受益。

不过最好一并考虑 平均响应时间 和 至少一种 百分位响应时间。
这样就不会错误有很大离群值的场景。
```
* 负载生成器
```md
* Faban
一个开源的，基于Java 的负载生成器。

$ fhb -w 1000 -r 300/300/60 -c 25  [url]
ops/sec: 8.247
% error: 0.0
avg. time: 0.022
max time:0.045
90th %: 0.030
95th %: 0.035
99th %: 0.035

25个客户端，每个请求周期时间1s （-w）。
-r 300/300/60 表示 基准测试 热身期是5分钟（300s），接下来 5分钟测试周期和1分钟减速期。

输入 OPS 和各种响应时间（由于存在思考时间，响应时间就成为了重要的度量，而 OPS 则在不断变化。）
```
> 请参考[faban.org](http://faban.org/)

## 原则3：用统计方法应对性能变化
## 原则4：尽早频繁测试